### 11.2 文件系统实现
---
#### 11.2.1 概述

- 磁盘中文件系统的信息
    - 简介：在磁盘中，文件系统可能包括如下信息：如何启动所存储的操作系统、总的块数、空闲块的数目和位置、目录结构以及各个具体文件等
    - 包括
        - 引导控制块(boot control block)
            - 系统从该卷引导操作系统那个所需的信息
            - 通常为卷的第一块
        - 卷控制块( volumn control block )
            - 包括卷的详细信息
            - 如块数、块的大小、空闲块的数量和指针、空闲FCB的数量和指针
        - 每个文件系统的目录结构用来组织文件
        - 每个文件的FCB
            - 包括许多某一文件的详细信息
            - 如文件权限、拥有者、大小和数据块的位置

- 内存内信息
    - 简介：文件系统加载到内存中的用于文件管理的信息
    - 包括
        - 安装表：所有安装卷的信息
        - 目录结构缓存：保存近来访问过的目录信息
        - 系统范围内的打开文件表：包括每个打开文件的FCB副本
        - 单个进程的打开文件表：指向系统打开文件表中合适条目的指针以及其他信息

- 创建文件的步骤
    1. 应用程序调用逻辑文件系统
    2. 逻辑文件系统分配一个新的FCB
    3. 系统将对应的目录信息读入内存
    4. 用新的文件名更新该目录和FCB
    5. 将结果写回到磁盘

- 打开文件
    1. 用户程序调用 `open()` 将文件名传给操作系统
    2. 搜索系统打开文件表寻找文件
    3. 若找到，直接在单个进程的打开文件表中创建一个条目，并指向系统打开文件表
    4. 若没找到，就搜索目录结构
    5. 在目录中找到后，将此文件FCB复制到系统范围内的打开文件表
    6. 在单个进程的打开文件表中创建一个条目，并指向系统打开文件表，并且向此条目中添加文件当前位置的指针和文件打开模式的信息

- 关闭文件
    - 当进程关闭文件，就删除该进程打开文件表中的对应条目
    - 当打开文件的所有用户都关闭一个文件，将此文件的元数据复制到磁盘的目录结构中，并在系统打开文件表中删除对应条目
---
#### 11.2.2 分区与安装

- 分区的生与熟
    - 分区是生的(raw)，即没有文件系统
    - 分区是熟的(cooked)，即含有文件系统
    - 生磁盘可以用于数据库、交换分区等

- 引导信息
    - 主要包括如何启动一个特定操作系统
    - 通常为一组有序块，从第一块开始，并作为镜像文件读入内存
    - 然后开始执行镜像文件，以引导操作系统的安装

- 根分区
    - 包括操作系统内核
    - 在引导时装入内存

- 其他非引导分区可以在引导时装入内存的安装表或之后手动装入
---
#### 11.2.3 虚拟文件系统
- 使用虚拟文件系统允许不同文件系统类型可通过同样结构来实现

- 文件系统实现包括三个主要层次
    1. 第一层为文件系统接口
        - 包括`open()`、`read()`、`write()`、`close()`调用以及文件描述符
    2. 第二层为虚拟文件系统层(VFS)
        1. VFS层通过定义一个清晰的VFS接口，以将文件系统的通用操作和具体实现分开
        2. VFS提供了在网络上唯一标志文件的机制
    3. 第三层为不同的文件系统类型层

- VFS为不同类型的文件系统定义了统一的接口，这些文件系统必须实现这些接口

- VFS软件层能够通过调用函数来进行操作，而不需关心函数的具体实现
---
&copy; 2018 T0UGH. All right reserved.