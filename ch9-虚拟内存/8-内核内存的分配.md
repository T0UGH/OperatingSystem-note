### 9.8 内核内存的分配
---

- 用户进程需要内存时，可以从内核所维护的空闲页帧链表中获得页

- 内核需要内存时，通常从空闲内存池获得，并不从满足用户进程的普通空闲页帧链表中获得，原因是
    1. 内存需要为不同大小的数据结构分配内存，内核必须谨慎使用内存，并试图减少碎片浪费
    2. 有的硬件需要直接与物理内存打交道，而不需要经过虚拟内存接口，因此需要内存常驻在连续的物理页中

---
#### 9.8.1 Buddy 系统

- Buddy 系统从物理上连续的大小固定的段上进行分配

- 内存按2的幂的大小来分配

- 如果请求大小不为2的幂，那么需要调整到下一个更大的2的幂

- 优点：可以通过合并而快速形成更大的段

- 缺点：调整到下一个2的幂容易产生碎片
---
#### 9.8.2 slab 分配

- slab 是由一个或多个物理上连续的页组成的

- 高速缓存(cache)含有一个或多个slab

- 每种内核数据结构都有一个cache，每个cache含有内核数据结构的对象实例

- 当创建cache时，起初包括若干标记为空闲的对象

- 当需要内核数据结构的对象时，可以从cache上直接获取，并把该对象标记为使用(used)

- slab可有三种状态
    - 满的：slab上的所有对象都标记为使用
    - 空闲：slab上的所有对象被标记为空闲
    - 部分：slab中的对象有的被标记为使用，有的被标记为空闲

- slab分配器的优点
    1. 没有因碎片而引起的内存浪费
        - 每个内核数据结构都有相应的cache
        - 每个cache都由若干slab组成
        - 每个slab又分为若干个与对象大小相同的部分
        - 因此，当内核请求对象内存时，slab分配器可以返回刚好可以表示对象所需的内存
    2. 内存请求可以快速满足
        - 由于对象预先创建，所以可从cache上快速分配
        - 当用完对象并释放时，只需要标记为空闲并返回给cache，以便下次使用
---
&copy; 2018 T0UGH. All rights reserved.