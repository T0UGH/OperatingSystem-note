### 12.5 磁盘管理
---
#### 12.5.1 磁盘格式化

- 低级格式化：在磁盘能存储数据之前，它必须分成扇区以便磁盘控制器能读和写

- 扇区的数据结构
    - 由头、数据区域和尾部组成
    - 头部和尾部包括一些磁盘控制器所使用的信息

- 纠错代码(error-correcting code,ECC)
    - 保存在扇区的头部
    - 当向扇区写入数据时，会更新ECC
    - ECC会用一个根据磁盘数据计算出来的值来更新
    - 当从扇区读取数据时，会重新计算ECC，并与储存才头部的ECC比较
    - 控制器在读写磁盘时会自动处理ECC

- 为了使用磁盘存储文件，操作系统还需要将自己的数据结构记录在磁盘上
    1. 将磁盘分为由一个或多个柱面组成的分区
        - 操作系统可以将每个分区作为一个独立的磁盘
    2. 逻辑格式化，创建文件系统
        - 操作系统将初始的文件系统数据结构存储在磁盘上
        - 这些数据结构包括
            - 空闲空间
            - 已分配的空间（FAT或inode）
            - 一个初始为空的目录

- 簇(cluster)
    - 磁盘I/O通过块完成，但是文件系统I/O通过簇完成
    - 有效确保了I/O可以进行更多的顺序存取和更少的随机存取

---
#### 12.5.2 引导块

- 初始化自举程序：
    - 为了让计算机开始运行，如当打开电源时或重启时，它需要运行一个初始化程序
    - 它初始化系统的各个方面，从CPU寄存器到设备控制器和内存，接着启动操作系统
    - 为此，自举程序应找到磁盘上的操作系统内核，装入内存，并转到起始地址，从而开始操作系统的执行
    - 自举程序保存在只读存储器（ROM）中

- 完整自举程序
    - 背景：因为初始化自举程序保存在ROM中，难以修改
    - 绝大多数操作系统只在ROM中保存一个很小的自举加载程序，它用来进一步从磁盘上调入更为完整的自举程序
    - 这个完整的自举程序保存在磁盘的启动块上，启动快位于磁盘的固定位置
    - 拥有启动分区的磁盘称为启动磁盘（boot disk）或系统磁盘（system disk）
    - 完整自举程序能从磁盘非固定位置中装入整个操作系统
---
#### 12.5.3 坏块

- 坏块：在磁盘中损坏的、不能使用的扇区就叫坏块

- 处理坏块的多种方式
    - MS-DOS的处理方式
        1. 使用format命令执行逻辑格式化
        2. 它将扫描磁盘并查找坏块
        3. 一旦找到坏块，就在相应的FAT条目中写入特殊值以通知分配程序不要使用该块
    - 扇区备用(sector sparing)
        1. 控制器维护一个磁盘坏块链表
        2. 低级格式化将一些块放在一边备用，操作系统看不到这些块
        3. 控制器可以用备用块来逻辑地替代坏块
    - 扇区滑动(sector slipping)
        1. 例如：逻辑块17变坏，第一个备用块是202，就将所有17-202的扇区向下滑动一个扇区
---
Copyleft ! 2018 T0UGH. All rights reserved under the MIT license.